---
cache:
  paths:
  - vendor/

phpunit:
  image: php:$PHP
  before_script:
    - apt-get update -yqq
    - apt-get install -yqq git libpq-dev libcurl4-gnutls-dev libicu-dev libvpx-dev libjpeg-dev
      libpng-dev libxpm-dev zlib1g-dev libfreetype6-dev libxml2-dev libexpat1-dev libbz2-dev
      libgmp3-dev libldap2-dev unixodbc-dev libsqlite3-dev libaspell-dev libsnmp-dev libpcre3-dev
      libtidy-dev libonig-dev libzip-dev
    - docker-php-ext-install mbstring pdo_pgsql curl intl gd xml zip bz2 opcache pdo_mysql
    - curl -sS https://getcomposer.org/installer | php
    - mv composer.phar /usr/local/bin/composer
  script:
    - make dev -B
    - make phpunit -B
  artifacts:
    when: always
    reports:
      junit: report.xml
  parallel:
    matrix:
      - PHP: ['8.1']
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'


integration:
  image: docker:latest
  needs: ["phpunit"]
  services:
    - docker:dind
  script:
    # start containeer
    - docker run --rm --name shop -d dockware/dev:$SHOPWARE
    - sleep 30
    - docker logs shop
    # upload into container
    - docker cp $(pwd)/. shop:/var/www/html/custom/plugins/PluszweiFaqManager
    - docker exec shop bash -c 'sudo chown www-data:www-data /var/www/html/custom/plugins -R'
    - docker exec shop bash -c 'sudo chown -R 33:33 /var/www'
    # install and build plugin
    - docker exec shop bash -c 'cd /var/www/html/custom/plugins/PluszweiFaqManager && make clean'
    - docker exec shop bash -c 'cd /var/www/html/custom/plugins/PluszweiFaqManager && make install'
    - docker exec shop bash -c 'cd /var/www/html/custom/plugins/PluszweiFaqManager && make build'
  parallel:
    matrix:
      # test versions from 6.5.0.0 https://github.com/dockware/dockware/tree/master/.dist/versions/master/dev
      - SHOPWARE: ['6.5.0.0-rc1']
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'